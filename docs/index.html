<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>遊具管理システム | 点検チェックシートページ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/destyle.css@1.0.15/destyle.css"/>
    <link rel="stylesheet" href="{{ url_for('static', filename='CSS/style.css') }}">
    <style>
        .ai-predicted { background-color: #e3f2fd !important; font-weight: bold; }
        .grade-A { color: #4caf50; }
        .grade-B { color: #ff9800; }
        .grade-C { color: #f44336; }
        .confidence-info { font-size: 0.8em; color: #666; }
    </style>
</head>
<body>
<header class="header">
    <div class="flexbox">
        <h1><a href="{{ url_for('home') }}">遊具管理システム</a></h1>
        <div class="account_toggle" id="mobile">
            <img src="{{ url_for('static', filename='img/Icon.svg') }}" alt="アカウント" id="accountIcon">
        </div>
        <button><img src="{{ url_for('static', filename='img/bell.png') }}" alt="通知"></button>
        <div class="nav_wrapper">
            <input type="checkbox" id="nav_toggle" hidden>
            <label class="nav_icon" for="nav_toggle">
                <span></span><span></span><span></span>
            </label>
            <div class="overlay"></div>
            <nav class="nav">
                <ul>
                    <li><a href="{{ url_for('home') }}">トップページ</a></li>
                    <li><a href="{{ url_for('daily_report') }}">日報作成</a></li>
                    <li><a href="{{ url_for('results_report') }}">結果報告書作成</a></li>
                    <li><a href="{{ url_for('CheckSheet') }}">点検チェックシート</a></li>
                    <li><a href="{{ url_for('Deterioration') }}">劣化進行・劣化予測</a></li>
                    <li><a href="{{ url_for('PhotoViewing') }}">写真閲覧</a></li>
                    <li><a href="{{ url_for('AllDocuments') }}">書類一覧</a></li>
                </ul>
            </nav>
        </div>
    </div>
</header>

<div class="wrapper">
    <p id="page_route"><a href="{{ url_for('home') }}">トップ</a> > <a href="{{ url_for('CheckSheet') }}">点検チェックシート</a></p>

    <!-- 検索フォーム -->
    <div class="section">
        <div class="CheckSheet_input_area AllDocuments_search_section">
            <label for="search_park">公園名</label><br>
            <input type="search" id="search_park" name="search_park" placeholder="キーワードを入力"><br>

            <label for="search_author">作成者名</label><br>
            <input type="search" id="search_author" name="search_author" placeholder="キーワードを入力"><br>

            <div class="CheckSheet_search_year">
                <label for="inspection_year">点検年度</label><br>
                <select id="inspection_year" name="inspection_year">
                    <option value="all" selected>すべて</option>
                    <option value="2025">令和７年度</option>
                    <option value="2024">令和６年度</option>
                    <option value="2023">令和５年度</option>
                </select>
            </div>
            <br>

            <div class="CheckSheet_search_wrapper">
                <div class="CheckSheet_search_year">
                    <label for="install_era">設置年度</label><br>
                    <select id="install_era" name="install_era">
                        <option value="reiwa" selected>令和</option>
                        <option value="heisei">平成</option>
                    </select>
                </div>
                <div class="CheckSheet_search_year">
                    <label for="install_year_num">　</label><br>
                    <select id="install_year_num" name="install_year_num">
                        {% for i in range(1, 32) %}
                        <option value="{{ i }}">{{ i }}年度</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <label for="inspection_date">点検日</label><br>
            <input type="date" id="inspection_date" name="inspection_date">
        </div>
    </div>

    <!-- 点検チェックシート -->
    <div class="section check_area">
        <h1>点検時の記録</h1>
        <table class="CheckSheet_list">
            <thead>
                <tr>
                    <th rowspan="2">点検部位</th>
                    <th rowspan="2">項目</th>
                    <th colspan="3">結果</th>
                    <th rowspan="2">写真</th>
                </tr>
                <tr>
                    <th>A<br>異常なし</th>
                    <th>B<br>経過観察</th>
                    <th>C<br>要対応</th>
                </tr>
            </thead>
            <tbody>
                {% for part in ["chain", "joint", "pole", "seat"] %}
                <tr id="row-{{ part }}" data-part="{{ part }}">
                    <td>{{ part|capitalize }}</td>
                    <td id="{{ part }}_item">{{ "錆・腐食" if part=="chain" else "磨耗・変形" if part=="joint" else "腐食・傾き" if part=="pole" else "割れ・損傷" }}</td>
                    {% for grade in ["A","B","C"] %}
                    <td>
                        <input type="radio" id="{{ part }}_{{ grade.lower() }}" name="{{ part }}" value="{{ grade }}">
                        <label class="checkbox_wrapper" for="{{ part }}_{{ grade.lower() }}"></label>
                    </td>
                    {% endfor %}
                    <td>
                        <a href="{{ url_for('TakePhoto') }}?inspection_id=1&row_index={{ part }}">
                            <button type="button"><img src="{{ url_for('static', filename='img/camera.png') }}" alt="写真"></button>
                        </a>
                        <span class="confidence-info" id="{{ part }}-confidence"></span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- 措置及び総合結果 -->
        <h1>措置及び総合結果</h1>
        <div class="CheckSheet_measure_area">
            <h2>●点検時に実施した措置</h2>
            <input type="checkbox" id="action_grease" name="action_grease" value="grease">
            <label for="action_grease">グリース・オイル等の注入</label><br>

            <input type="checkbox" id="action_bolt" name="action_bolt" value="bolt">
            <label for="action_bolt">ボルト・ナットの増し締め・交換</label><br>

            <input type="checkbox" id="action_other" name="action_other" value="other">
            <label for="action_other">その他</label>
            <input type="text" id="action_other_detail" name="action_other_detail" class="result_short_opinion"><br>

            <label for="observations">●所見</label><br>
            <textarea id="observations" name="observations" class="result_long_opinion"></textarea>
        </div>

        <h2>●総合結果</h2>
        {% for grade in ["A","B","C","D"] %}
        <input type="radio" id="overall_{{ grade.lower() }}" name="overall_result" value="{{ grade }}">
        <label for="overall_{{ grade.lower() }}">{{ grade }}：{{ "健全" if grade=="A" else "経過観察" if grade=="B" else "要修繕・要対応" if grade=="C" else "使用禁止措置" }}</label>
        {% if grade=="D" %}
        <input type="text" id="overall_d_detail" name="overall_d_detail" class="result_short_opinion">
        {% endif %}
        <br>
        {% endfor %}

        <h1>以下は点検後の記録（担当者記入欄）</h1>
        <h2>●対応方針</h2>
        <input type="checkbox" id="plan_maintenance" name="plan_maintenance" value="maintenance">
        <label for="plan_maintenance">整備班で対応予定</label><br>

        <h2>●対応予定時期</h2>
        <select id="response_month" name="response_month">
            {% for i in range(1,13) %}
            <option value="{{ i }}">{{ i }}月</option>
            {% endfor %}
        </select>
        <input type="radio" id="period_early" name="period" value="early"><label for="period_early">上旬</label>
        <input type="radio" id="period_mid" name="period" value="mid"><label for="period_mid">中旬</label>
        <input type="radio" id="period_late" name="period" value="late"><label for="period_late">下旬</label><br><br>

        <label for="remarks">●備考</label><br>
        <textarea id="remarks" name="remarks" class="result_long_opinion"></textarea><br>

        <div class="CheckSheet_save_button">
            <button type="button" id="save_btn">保存</button>
        </div>
    </div>
</div>

<script>
document.getElementById("save_btn").addEventListener("click", async function() {
    const data = {
        park_name: document.getElementById("search_park").value,
        inspection_date: document.getElementById("inspection_date").value,
        install_year: document.getElementById("install_year_num").value,
        parts: [
            {part:"chain", grade: document.querySelector('input[name="chain"]:checked')?.value || "A"},
            {part:"joint", grade: document.querySelector('input[name="joint"]:checked')?.value || "A"},
            {part:"pole", grade: document.querySelector('input[name="pole"]:checked')?.value || "A"},
            {part:"seat", grade: document.querySelector('input[name="seat"]:checked')?.value || "A"}
        ],
        actions: {
            grease: document.getElementById("action_grease").checked,
            bolt: document.getElementById("action_bolt").checked,
            hanger: parseInt(document.getElementById("hanger_count").value) || 0,
            chain: parseInt(document.getElementById("chain_count").value) || 0,
            seat: parseInt(document.getElementById("seat_count").value) || 0,
            removal: document.getElementById("action_removal").checked,
            other: document.getElementById("action_other_detail").value
        },
        plans: {
            maintenance: document.getElementById("plan_maintenance").checked,
            repair: document.getElementById("plan_repair").checked,
            improvement: document.getElementById("plan_improvement").checked,
            precision: document.getElementById("plan_precision").checked,
            removal: document.getElementById("plan_removal").checked,
            other: document.getElementById("plan_other_detail").value
        },
        response_month: document.getElementById("response_month").value,
        period: document.querySelector('input[name="period"]:checked')?.value,
        overall: document.querySelector('input[name="overall_result"]:checked')?.value,
        overall_d_detail: document.getElementById("overall_d_detail").value,
        remarks: document.getElementById("remarks").value,
        observations: document.getElementById("observations").value
    };

    const response = await fetch("http://127.0.0.1:5000/api/save_sheet", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(data)
    });

    const blob = await response.blob();
    const link = document.createElement("a");
    link.href = window.URL.createObjectURL(blob);
    link.download = "CheckSheet.xlsx";
    link.click();
});
</script>

document.addEventListener('DOMContentLoaded', async function() {
    const latestResult = localStorage.getItem('latestAIResult');
    if(latestResult){
        const aiData = JSON.parse(latestResult);
        updatePartResult(aiData.part, aiData.result, aiData.confidence, true);
        localStorage.removeItem('latestAIResult');
    }

    await loadInspectionResults(1);

    document.getElementById('save_button').addEventListener('click', saveSheet);
});

async function loadInspectionResults(inspectionId){
    try{
        const res = await fetch(`/api/inspection/${inspectionId}/results`);
        if(!res.ok) return;
        const data = await res.json();
        data.parts.forEach(part=>{
            updatePartResult(part.part, part.grade, part.confidence, part.is_ai_predicted);
        });
    }catch(e){console.error(e);}
}

function updatePartResult(partName, grade, confidence, isAI){
    const radio = document.getElementById(`${partName}_${grade.toLowerCase()}`);
    if(radio) radio.checked = true;
    if(isAI){
        const row = document.getElementById(`row-${partName}`);
        if(row) row.classList.add('ai-predicted');
        if(confidence){
            const span = document.getElementById(`${partName}-confidence`);
            if(span){ span.textContent = `(AI判定: ${(confidence*100).toFixed(1)}%)`; span.classList.add(`grade-${grade}`);}
        }
    }
}

async function saveSheet(){
    const payload = {
        park: document.getElementById('search_park').value,
        inspection_date: document.getElementById('inspection_date').value,
        install_era: document.getElementById('install_era').value,
        install_year_num: document.getElementById('install_year_num').value,
        remarks: document.getElementById('remarks').value,
        parts: []
    };

    ['chain','joint','pole','seat'].forEach(p=>{
        const radios = document.getElementsByName(p);
        radios.forEach(r=>{
            if(r.checked) payload.parts.push({part:p, grade:r.value});
        });
    });

    const res = await fetch('/api/save_sheet', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
    });
    if(res.ok) alert('保存しました');
    else alert('保存失敗');
}
</script>
</body>
</html>
