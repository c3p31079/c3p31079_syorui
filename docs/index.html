<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>点検入力</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>点検入力</h1>

    <div class="form-grid">
      <div class="form-row">
        <label>点検部位</label>
        <input id="part" type="text" value="チェーン">
      </div>
      <div class="form-row">
        <label>項目</label>
        <input id="item" type="text" value="腐食">
      </div>
      <div class="form-row">
        <label>score (0〜1)</label>
        <input id="score" type="number" step="0.01" min="0" max="1" value="0.5">
      </div>
      <div class="form-row">
        <label>チェック（複数可）</label>
        <textarea id="checks" placeholder="チェック項目をカンマ区切りで入れてください（例：整備班で対応予定,撤去予定）" rows="3"></textarea>
      </div>
    </div>

    <div class="actions">
      <button id="doPreview">プレビューを見る</button>
      <span id="status"></span>
    </div>

    <p class="hint">「プレビューを見る」を押すとプレビュー画面が開きます。プレビュー内でExcelダウンロード可能。</p>
  </div>

  <script>
  const BACKEND_BASE = "http://localhost:5000";

  document.getElementById("doPreview").addEventListener("click", async () => {
    const part = document.getElementById("part").value;
    const item = document.getElementById("item").value;
    const score = Number(document.getElementById("score").value);
    const checksRaw = document.getElementById("checks").value;
    const checks = checksRaw.split(",").map(s => s.trim()).filter(Boolean);

    // バックエンドからシート画像を取得
    const res = await fetch(`${BACKEND_BASE}/api/sheet-image`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ sheet: "Sheet1", range: "A1:H37" })
    });
    if (!res.ok) {
      alert("プレビュー画像の生成に失敗しました");
      return;
    }
    const blob = await res.blob();
    const reader = new FileReader();
    reader.onload = function() {
      const imgDataUrl = reader.result;
      const payload = {
        part, item, score, checks, imgDataUrl
      };
      sessionStorage.setItem("previewPayload", JSON.stringify(payload));
      location.href = "preview.html";
    };
    reader.readAsDataURL(blob);
  });
  </script>
</body>
</html>
