<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>遊具管理システム | 点検チェックシートページ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/destyle.css@1.0.15/destyle.css"/>
    <link rel="stylesheet" href="{{ url_for('static', filename='CSS/style.css') }}">
    <style>
        .ai-predicted { background-color: #e3f2fd !important; font-weight: bold; }
        .grade-A { color: #4caf50; }
        .grade-B { color: #ff9800; }
        .grade-C { color: #f44336; }
        .confidence-info { font-size: 0.8em; color: #666; }
    </style>
</head>
<body>
<header class="header">
    <div class="flexbox">
        <h1><a href="{{ url_for('home') }}">遊具管理システム</a></h1>
        <div class="account_toggle" id="mobile">
            <img src="{{ url_for('static', filename='img/Icon.svg') }}" alt="アカウント" id="accountIcon">
        </div>
        <button><img src="{{ url_for('static', filename='img/bell.png') }}" alt="通知"></button>
        <div class="nav_wrapper">
            <input type="checkbox" id="nav_toggle" hidden>
            <label class="nav_icon" for="nav_toggle">
                <span></span>
                <span></span>
                <span></span>
            </label>
            <div class="overlay"></div>
            <nav class="nav">
                <ul>
                    <li><a href="{{ url_for('home') }}">トップページ</a></li>
                    <li><a href="{{ url_for('daily_report') }}">日報作成</a></li>
                    <li><a href="{{ url_for('results_report') }}">結果報告書作成</a></li>
                    <li><a href="{{ url_for('CheckSheet') }}">点検チェックシート</a></li>
                    <li><a href="{{ url_for('Deterioration') }}">劣化進行・劣化予測</a></li>
                    <li><a href="{{ url_for('PhotoViewing') }}">写真閲覧</a></li>
                    <li><a href="{{ url_for('AllDocuments') }}">書類一覧</a></li>         
                </ul>
            </nav>
        </div>
    </div>
</header>

<div class="wrapper">
    <p id="page_route"><a href="{{ url_for('home') }}">トップ</a> > <a href="{{ url_for('CheckSheet') }}">点検チェックシート</a></p>

    <!-- ========================================
         検索フォーム
         ======================================== -->
    <div class="section">
        <div class="CheckSheet_input_area AllDocuments_search_section">
            <label for="search_park">公園名</label><br>
            <input type="search" id="search_park" name="search_park" placeholder="キーワードを入力"><br>
            
            <label for="search_author">作成者名</label><br>
            <input type="search" id="search_author" name="search_author" placeholder="キーワードを入力"><br>
            
            <label for="inspection_year">点検年度</label><br>
            <select id="inspection_year" name="inspection_year">
                <option value="all" selected>すべて</option>
                <option value="2025">令和７年度</option>
                <option value="2024">令和６年度</option>
                <option value="2023">令和５年度</option>
            </select><br>

            <label for="install_era">設置年度</label><br>
            <select id="install_era" name="install_era">
                <option value="reiwa" selected>令和</option>
                <option value="heisei">平成</option>
            </select>
            <select id="install_year_num" name="install_year_num">
                <option value="1">１年度</option>
                <option value="2">２年度</option>
                <option value="3">３年度</option>
                <option value="4">４年度</option>
                <option value="5">５年度</option>
                <option value="6">６年度</option>
                <option value="7">７年度</option>
                <option value="8">８年度</option>
                <option value="9">９年度</option>
                <option value="10">１０年度</option>
                <option value="11">１１年度</option>
                <option value="12">１２年度</option>
                <option value="13">１３年度</option>
                <option value="14">１４年度</option>
                <option value="15">１５年度</option>
                <option value="16">１６年度</option>
                <option value="17">１７年度</option>
                <option value="18">１８年度</option>
                <option value="19">１９年度</option>
                <option value="20">２０年度</option>
                <option value="21">２１年度</option>
                <option value="22">２２年度</option>
                <option value="23">２３年度</option>
                <option value="24">２４年度</option>
                <option value="25">２５年度</option>
                <option value="26">２６年度</option>
                <option value="27">２７年度</option>
                <option value="28">２８年度</option>
                <option value="29">２９年度</option>
                <option value="30">３０年度</option>
                <option value="31">３１年度</option>
            </select><br>

            <label for="inspection_date">点検日</label><br>
            <input type="date" id="inspection_date" name="inspection_date">
        </div>
    </div>

    <!-- ========================================
         点検チェックシート
         ======================================== -->
    <div class="section check_area">
        <h1>点検時の記録</h1>
        <form id="checksheet_form">
            <table class="CheckSheet_list">
                <thead>
                    <tr>
                        <th rowspan="2">点検部位</th>
                        <th rowspan="2">項目</th>
                        <th colspan="3">結果</th>
                        <th rowspan="2">写真</th>
                    </tr>
                    <tr>
                        <th>A<br>異常なし</th>
                        <th>B<br>経過観察</th>
                        <th>C<br>要対応</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 点検部位ごとに最初の行だけ部位表示 -->
                    <tr id="row-柱・梁（本体）">
                        <td rowspan="5">柱・梁（本体）</td>
                        <td>ぐらつき</td>
                        <td><input type="radio" name="pillar_grade_ぐらつき" value="A"></td>
                        <td><input type="radio" name="pillar_grade_ぐらつき" value="B"></td>
                        <td><input type="radio" name="pillar_grade_ぐらつき" value="C"></td>
                        <td></td>
                    </tr>
                    <tr><td>破損</td><td><input type="radio" name="pillar_grade_破損" value="A"></td><td><input type="radio" name="pillar_grade_破損" value="B"></td><td><input type="radio" name="pillar_grade_破損" value="C"></td><td></td></tr>
                    <tr><td>変形</td><td><input type="radio" name="pillar_grade_変形" value="A"></td><td><input type="radio" name="pillar_grade_変形" value="B"></td><td><input type="radio" name="pillar_grade_変形" value="C"></td><td></td></tr>
                    <tr><td>腐食 (腐朽)</td><td><input type="radio" name="pillar_grade_腐食" value="A"></td><td><input type="radio" name="pillar_grade_腐食" value="B"></td><td><input type="radio" name="pillar_grade_腐食" value="C"></td><td></td></tr>
                    <tr><td>接合部の緩み</td><td><input type="radio" name="pillar_grade_接合部の緩み" value="A"></td><td><input type="radio" name="pillar_grade_接合部の緩み" value="B"></td><td><input type="radio" name="pillar_grade_接合部の緩み" value="C"></td><td></td></tr>

                    <!-- 接合部(継ぎ手) -->
                    <tr id="row-接合部(継ぎ手)">
                        <td rowspan="5">接合部(継ぎ手)</td>
                        <td>破損</td><td><input type="radio" name="joint_grade_破損" value="A"></td><td><input type="radio" name="joint_grade_破損" value="B"></td><td><input type="radio" name="joint_grade_破損" value="C"></td><td></td>
                    </tr>
                    <tr><td>変形</td><td><input type="radio" name="joint_grade_変形" value="A"></td><td><input type="radio" name="joint_grade_変形" value="B"></td><td><input type="radio" name="joint_grade_変形" value="C"></td><td></td></tr>
                    <tr><td>腐食</td><td><input type="radio" name="joint_grade_腐食" value="A"></td><td><input type="radio" name="joint_grade_腐食" value="B"></td><td><input type="radio" name="joint_grade_腐食" value="C"></td><td></td></tr>
                    <!-- 吊金具 -->
                    <tr id="row-吊金具">
                        <td rowspan="8">吊金具</td>
                        <td>破損</td><td><input type="radio" name="hanger_grade_破損" value="A"></td><td><input type="radio" name="hanger_grade_破損" value="B"></td><td><input type="radio" name="hanger_grade_破損" value="C"></td><td></td>
                    </tr>
                    <tr><td>変形</td><td><input type="radio" name="hanger_grade_変形" value="A"></td><td><input type="radio" name="hanger_grade_変形" value="B"></td><td><input type="radio" name="hanger_grade_変形" value="C"></td><td></td></tr>
                    <tr><td>腐食</td><td><input type="radio" name="hanger_grade_腐食" value="A"></td><td><input type="radio" name="hanger_grade_腐食" value="B"></td><td><input type="radio" name="hanger_grade_腐食" value="C"></td><td></td></tr>
                    <tr><td>異音</td><td><input type="radio" name="hanger_grade_異音" value="A"></td><td><input type="radio" name="hanger_grade_異音" value="B"></td><td><input type="radio" name="hanger_grade_異音" value="C"></td><td></td></tr>
                    <tr><td>金具本体のずれ</td><td><input type="radio" name="hanger_grade_ずれ" value="A"></td><td><input type="radio" name="hanger_grade_ずれ" value="B"></td><td><input type="radio" name="hanger_grade_ずれ" value="C"></td><td></td></tr>
                    <tr><td>摩耗(×:1/3以上、1/2以上は使用禁止)</td><td><input type="radio" name="hanger_grade_摩耗" value="A"></td><td><input type="radio" name="hanger_grade_摩耗" value="B"></td><td><input type="radio" name="hanger_grade_摩耗" value="C"></td><td></td></tr>
                    <tr><td>ボルトの緩み</td><td><input type="radio" name="hanger_grade_ボルト" value="A"></td><td><input type="radio" name="hanger_grade_ボルト" value="B"></td><td><input type="radio" name="hanger_grade_ボルト" value="C"></td><td></td></tr>
                    <tr><td>欠落</td><td><input type="radio" name="hanger_grade_欠落" value="A"></td><td><input type="radio" name="hanger_grade_欠落" value="B"></td><td><input type="radio" name="hanger_grade_欠落" value="C"></td><td></td></tr>

                    <!-- 揺動部（チェーン・ロープ） -->
                    <tr id="row-揺動部チェーン">
                        <td rowspan="6">揺動部（チェーン・ロープ）</td>
                        <td>ねじれ</td><td><input type="radio" name="swing_chain_grade_ねじれ" value="A"></td><td><input type="radio" name="swing_chain_grade_ねじれ" value="B"></td><td><input type="radio" name="swing_chain_grade_ねじれ" value="C"></td><td></td>
                    </tr>
                    <tr><td>変形</td><td><input type="radio" name="swing_chain_grade_変形" value="A"></td><td><input type="radio" name="swing_chain_grade_変形" value="B"></td><td><input type="radio" name="swing_chain_grade_変形" value="C"></td><td></td></tr>
                    <tr><td>破損</td><td><input type="radio" name="swing_chain_grade_破損" value="A"></td><td><input type="radio" name="swing_chain_grade_破損" value="B"></td><td><input type="radio" name="swing_chain_grade_破損" value="C"></td><td></td></tr>
                    <tr><td>ほつれ</td><td><input type="radio" name="swing_chain_grade_ほつれ" value="A"></td><td><input type="radio" name="swing_chain_grade_ほつれ" value="B"></td><td><input type="radio" name="swing_chain_grade_ほつれ" value="C"></td><td></td></tr>
                    <tr><td>断線</td><td><input type="radio" name="swing_chain_grade_断線" value="A"></td><td><input type="radio" name="swing_chain_grade_断線" value="B"></td><td><input type="radio" name="swing_chain_grade_断線" value="C"></td><td></td></tr>
                    <tr><td>摩耗(×:1/3以上、1/2以上は使用禁止)</td><td><input type="radio" name="swing_chain_grade_摩耗" value="A"></td><td><input type="radio" name="swing_chain_grade_摩耗" value="B"></td><td><input type="radio" name="swing_chain_grade_摩耗" value="C"></td><td></td></tr>

                    <!-- 揺動部（座板・座面(タイヤ)） -->
                    <tr id="row-揺動部座板">
                        <td rowspan="8">揺動部（座板・座面(タイヤ)）</td>
                        <td>ヒビ</td><td><input type="radio" name="seat_grade_ヒビ" value="A"></td><td><input type="radio" name="seat_grade_ヒビ" value="B"></td><td><input type="radio" name="seat_grade_ヒビ" value="C"></td><td></td>
                    </tr>
                    <tr><td>割れ</td><td><input type="radio" name="seat_grade_割れ" value="A"></td><td><input type="radio" name="seat_grade_割れ" value="B"></td><td><input type="radio" name="seat_grade_割れ" value="C"></td><td></td></tr>
                    <tr><td>湾曲等変形</td><td><input type="radio" name="seat_grade_湾曲" value="A"></td><td><input type="radio" name="seat_grade_湾曲" value="B"></td><td><input type="radio" name="seat_grade_湾曲" value="C"></td><td></td></tr>
                    <tr><td>破損</td><td><input type="radio" name="seat_grade_破損" value="A"></td><td><input type="radio" name="seat_grade_破損" value="B"></td><td><input type="radio" name="seat_grade_破損" value="C"></td><td></td></tr>
                    <tr><td>腐朽</td><td><input type="radio" name="seat_grade_腐朽" value="A"></td><td><input type="radio" name="seat_grade_腐朽" value="B"></td><td><input type="radio" name="seat_grade_腐朽" value="C"></td><td></td></tr>
                    <tr><td>金具の摩耗(× :1/3以上、1/2以上は使用禁止)</td><td><input type="radio" name="seat_grade_金具摩耗" value="A"></td><td><input type="radio" name="seat_grade_金具摩耗" value="B"></td><td><input type="radio" name="seat_grade_金具摩耗" value="C"></td><td></td></tr>
                    <tr><td>ボルト、袋ナットの緩み</td><td><input type="radio" name="seat_grade_ボルト緩み" value="A"></td><td><input type="radio" name="seat_grade_ボルト緩み" value="B"></td><td><input type="radio" name="seat_grade_ボルト緩み" value="C"></td><td></td></tr>
                    <tr><td>欠落</td><td><input type="radio" name="seat_grade_欠落" value="A"></td><td><input type="radio" name="seat_grade_欠落" value="B"></td><td><input type="radio" name="seat_grade_欠落" value="C"></td><td></td></tr>

                    <!-- 安全柵 -->
                    <tr id="row-安全柵">
                        <td rowspan="8">安全柵</td>
                        <td>ぐらつき</td><td><input type="radio" name="safety_grade_ぐらつき" value="A"></td><td><input type="radio" name="safety_grade_ぐらつき" value="B"></td><td><input type="radio" name="safety_grade_ぐらつき" value="C"></td><td></td>
                    </tr>
                    <tr><td>破損</td><td><input type="radio" name="safety_grade_破損" value="A"></td><td><input type="radio" name="safety_grade_破損" value="B"></td><td><input type="radio" name="safety_grade_破損" value="C"></td><td></td></tr>
                    <tr><td>変形</td><td><input type="radio" name="safety_grade_変形" value="A"></td><td><input type="radio" name="safety_grade_変形" value="B"></td><td><input type="radio" name="safety_grade_変形" value="C"></td><td></td></tr>
                    <tr><td>腐食</td><td><input type="radio" name="safety_grade_腐食" value="A"></td><td><input type="radio" name="safety_grade_腐食" value="B"></td><td><input type="radio" name="safety_grade_腐食" value="C"></td><td></td></tr>
                    <tr><td>〔接合部・ボルト〕緩み</td><td><input type="radio" name="safety_grade_接合緩み" value="A"></td><td><input type="radio" name="safety_grade_接合緩み" value="B"></td><td><input type="radio" name="safety_grade_接合緩み" value="C"></td><td></td></tr>
                    <tr><td>欠落</td><td><input type="radio" name="safety_grade_欠落" value="A"></td><td><input type="radio" name="safety_grade_欠落" value="B"></td><td><input type="radio" name="safety_grade_欠落" value="C"></td><td></td></tr>
                    <!-- その他 -->
                    <tr id="row-その他">
                        <td>その他</td>
                        <td>異物、落書き</td>
                        <td><input type="radio" name="other_grade" value="A"></td>
                        <td><input type="radio" name="other_grade" value="B"></td>
                        <td><input type="radio" name="other_grade" value="C"></td>
                        <td></td>
                    </tr>

                    <!-- 基礎 -->
                    <tr id="row-基礎">
                        <td>基礎</td>
                        <td>基礎が露出、亀裂、破損</td>
                        <td><input type="radio" name="foundation_grade" value="A"></td>
                        <td><input type="radio" name="foundation_grade" value="B"></td>
                        <td><input type="radio" name="foundation_grade" value="C"></td>
                        <td></td>
                    </tr>

                    <!-- 地表部・安全柵内 -->
                    <tr id="row-地表部">
                        <td>地表部・安全柵内</td>
                        <td>大きな凹凸、石や根の露出、異物、マットのめくれ、破損、樹木の枝</td>
                        <td><input type="radio" name="ground_grade" value="A"></td>
                        <td><input type="radio" name="ground_grade" value="B"></td>
                        <td><input type="radio" name="ground_grade" value="C"></td>
                        <td></td>
                    </tr>
                </tbody>
            </table>

            <!-- ========================================
                 措置・総合結果・対応方針
                 ======================================== -->
            <div class="CheckSheet_measure_area">
                <h1>措置及び総合結果</h1>
                <h2>●点検時に実施した措置</h2>
                <input type="checkbox" id="action_grease" name="action_grease" value="grease">
                <label for="action_grease">グリース・オイル等の注入</label><br>

                <input type="checkbox" id="action_bolt" name="action_bolt" value="bolt">
                <label for="action_bolt">ボルト・ナットの増し締め・交換</label><br>

                <input type="checkbox" id="action_hanger" name="action_hanger" value="hanger">
                <label for="action_hanger">吊金具の交換</label>
                <input type="number" id="hanger_count" name="hanger_count" min="0"> 箇所<br>

                <input type="checkbox" id="action_chain" name="action_chain" value="chain">
                <label for="action_chain">チェーンの交換</label>
                <input type="number" id="chain_count" name="chain_count" min="0"> 箇所<br>

                <input type="checkbox" id="action_seat" name="action_seat" value="seat">
                <label for="action_seat">座板の交換</label>
                <input type="number" id="seat_count" name="seat_count" min="0"> 箇所<br>

                <input type="checkbox" id="action_removal" name="action_removal" value="removal">
                <label for="action_removal">石・異物の除去、枝の剪定</label><br>

                <input type="checkbox" id="action_other" name="action_other" value="other">
                <label for="action_other">その他</label>
                <input type="text" id="action_other_detail" name="action_other_detail" class="result_short_opinion"><br>

                <label for="observations">●所見</label><br>
                <textarea id="observations" name="observations" class="result_long_opinion"></textarea>

                <h2>●総合結果</h2>
                <input type="radio" id="overall_a" name="overall_result" value="A">
                <label for="overall_a">Ａ：健全（△・×なし）</label><br>
                <input type="radio" id="overall_b" name="overall_result" value="B">
                <label for="overall_b">Ｂ：経過観察（△あり、×なし）</label><br>
                <input type="radio" id="overall_c" name="overall_result" value="C">
                <label for="overall_c">Ｃ：要修繕・要対応（×あり）</label><br>
                <input type="radio" id="overall_d" name="overall_result" value="D">
                <label for="overall_d">Ｄ：使用禁止措置</label>
                <input type="text" id="overall_d_detail" name="overall_d_detail" class="result_short_opinion"><br>

                <h2>●対応方針</h2>
                <input type="checkbox" id="plan_maintenance" name="plan_maintenance" value="maintenance">
                <label for="plan_maintenance">整備班で対応予定</label><br>
                <input type="checkbox" id="plan_repair" name="plan_repair" value="repair">
                <label for="plan_repair">修繕・修繕工事で対応予定</label><br>
                <input type="checkbox" id="plan_improvement" name="plan_improvement" value="improvement">
                <label for="plan_improvement">施設改良工事で対応予定</label><br>
                <input type="checkbox" id="plan_precision" name="plan_precision" value="precision">
                <label for="plan_precision">精密点検予定</label><br>
                <input type="checkbox" id="plan_removal" name="plan_removal" value="removal">
                <label for="plan_removal">撤去予定</label><br>
                <input type="checkbox" id="plan_other" name="plan_other" value="other">
                <label for="plan_other">その他</label>
                <input type="text" id="plan_other_detail" name="plan_other_detail" class="result_short_opinion"><br>

                <h2>●対応予定時期</h2>
                <select id="response_month" name="response_month">
                    <option value="1">１月</option>
                    <option value="2">２月</option>
                    <option value="3">３月</option>
                    <option value="4">４月</option>
                    <option value="5">５月</option>
                    <option value="6">６月</option>
                    <option value="7">７月</option>
                    <option value="8">８月</option>
                    <option value="9">９月</option>
                    <option value="10">１０月</option>
                    <option value="11">１１月</option>
                    <option value="12">１２月</option>
                </select>
                <input type="radio" id="period_early" name="period" value="early"><label for="period_early">上旬</label>
                <input type="radio" id="period_mid" name="period" value="mid"><label for="period_mid">中旬</label>
                <input type="radio" id="period_late" name="period" value="late"><label for="period_late">下旬</label><br><br>

                <input type="checkbox" id="prohibition_measure" name="prohibition_measure" value="prohibition">
                <label for="prohibition_measure">本格的な使用禁止措置</label><br>
                <label for="prohibition_date">実施日</label>
                <input type="date" id="prohibition_date" name="prohibition_date"><br>
                <input type="radio" id="prohibition_done" name="prohibition_status" value="done"><label for="prohibition_done">実施済み</label>
                <input type="radio" id="prohibition_planned" name="prohibition_status" value="planned"><label for="prohibition_planned">実施予定</label><br><br>

                <label for="remarks">●備考</label><br>
                <textarea id="remarks" name="remarks" class="result_long_opinion"></textarea><br>

                <div class="CheckSheet_save_button">
                    <button id="save_excel">Excelでダウンロード</button>
                </div>
            </div>
        </div>

        <script>
            // 保存ボタン：フォームの値をJSONでapp.pyに送信してExcel生成
            document.getElementById('save_excel').addEventListener('click', async function() {
                const formData = new FormData(document.querySelector('form, .wrapper'));
                const jsonData = {};

                formData.forEach((value, key) => {
                    if(jsonData[key]) {
                        if(Array.isArray(jsonData[key])) {
                            jsonData[key].push(value);
                        } else {
                            jsonData[key] = [jsonData[key], value];
                        }
                    } else {
                        jsonData[key] = value;
                    }
                });

                try {
                    const response = await fetch('/api/generate_excel', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(jsonData)
                    });

                    if(!response.ok) throw new Error('Excel生成失敗');

                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = '点検チェックシート.xlsx';
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                } catch(err) {
                    alert(err);
                }
            });
        </script>
    </body>
</html>
